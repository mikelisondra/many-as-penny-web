{% extends "base.html" %}

{% block content %}
<div class="header">
    <h1>Many As Penny (MAP)</h1>
    <p>Live Stock Tracker and Alert System</p>
    <form action="{{ url_for('add_stock') }}" method="POST" class="add-form">
        <input type="text" name="new_stock_symbol" placeholder="Search by name or ticker" required>
        <button type="submit">Add Stock</button>
    </form>
</div>

<div class="container">
    {% if stocks %}
        {% for stock in stocks %}
        
            <div class="stock-card">
                
                <form action="{{ url_for('delete_stock') }}" method="POST" class="delete-form">
                    <input type="hidden" name="stock_id" value="{{ stock.id }}">
                    <button type="submit" title="Delete Stock">X</button>
                </form>
                
                <div class="stock-info">
                    {% if stock.error %}
                        <div class="stock-symbol">{{ stock.symbol }}</div>
                        <p class="error">{{ stock.error }}</p>
                    {% else %}
                        <div class="stock-symbol">{{ stock.symbol }}</div>
                        <div class="company-name">{{ stock.name | default('N/A', true) }}</div>
                        
                        <div class="current-price">${{ "%.2f"|format(stock.current_price) }}</div>
                        
                        {% if stock.percent_change >= 0 %}
                            <div class="price-change positive">
                                +${{ "%.2f"|format(stock.price_change) }} (+{{ "%.2f"|format(stock.percent_change) }}%) ▲
                            </div>
                        {% else %}
                            <div class="price-change negative">
                                ${{ "%.2f"|format(stock.price_change) }} ({{ "%.2f"|format(stock.percent_change) }}%) ▼
                            </div>
                        {% endif %}
                        <div class="details">
                            <p>Open: <span>${{ "%.2f"|format(stock.opening_price) }}</span></p>
                            <p>High: <span>${{ "%.2f"|format(stock.high_price) }}</span></p>
                            <p>Low: <span>${{ "%.2f"|format(stock.low_price) }}</span></p>
                        </div>
                    {% endif %}
                </div>
                
                <form action="{{ url_for('add_alert') }}" method="POST" class="alert-form">
                    <input type="hidden" name="stock_id" value="{{ stock.id }}">
                    
                    <input type="email" name="alert_email" placeholder="Enter email for alert" required>
                    
                    <div class="price-row">
                        <input type="number" step="0.01" name="target_price" placeholder="Target Price" required>
                        <select name="alert_type" required>
                            <option value="high">Alert if &ge;</option> <option value="low">Alert if &le;</option>  </select>
                    </div>
                    <button type="submit">Add Alert</button>
                </form>

                <div class="existing-alerts">
                    <h4>Current Alerts</h4>
                    {% for alert in stock.alerts %}
                        <div class="alert-row {% if alert.is_triggered %}triggered{% endif %}">
                            <span class="email-text" title="{{ alert.alert_email }}">
                                {{ alert.alert_email }}:
                                <strong>
                                    {% if alert.alert_type == 'high' %}&ge;{% else %}&le;{% endif %}
                                    ${{ "%.2f"|format(alert.target_price) }}
                                </strong>
                            </span>
                            <form action="{{ url_for('delete_alert') }}" method="POST" class="alert-row-delete-form">
                                <input type="hidden" name="alert_id" value="{{ alert.id }}">
                                <button type="submit" title="Delete this alert">X</button>
                            </form>
                        </div>
                    {% else %}
                        <p style="text-align: center; font-size: 0.9em; color: #777;">No alerts set.</p>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p>No stocks added yet. Use the form above to add one!</p>
    {% endif %}
</div>
{% endblock %}